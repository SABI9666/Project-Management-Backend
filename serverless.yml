service: eb-tracker-backend
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'production'}
  region: ap-south-1
  memorySize: 512
  timeout: 30
  
  environment:
    REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}
    
    # DynamoDB Tables
    PROPOSALS_TABLE: PMTracker-Proposals
    PROJECTS_TABLE: PMTracker-Projects
    FILES_TABLE: PMTracker-Files
    TIMESHEETS_TABLE: PMTracker-Timesheets
    TIME_REQUESTS_TABLE: PMTracker-TimeRequests
    DELIVERABLES_TABLE: PMTracker-Deliverables
    ACTIVITIES_TABLE: PMTracker-Activities
    NOTIFICATIONS_TABLE: PMTrackerNotifications
    PAYMENTS_TABLE: PMTrackerPayments
    INVOICES_TABLE: PMTracker-Invoices
    TASKS_TABLE: PMTracker-Tasks
    USERS_TABLE: PMTracker-Users
    SUBMISSIONS_TABLE: PMTracker-Submissions
    ANALYTICS_TABLE: PMTracker-Analytics
    
    # S3 Bucket (Mumbai - UPDATED with correct name)
    S3_BUCKET: pmtracker-files-mumbai-2024
    
    # Cognito
    COGNITO_USER_POOL_ID: ap-south-1_ydwkta
    COGNITO_CLIENT_ID: 2MMb8hmRRb
    
    # JWT Secret
    JWT_SECRET: "7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d"
    
    # Email
    FROM_EMAIL: noreply@pmtracker.com
    FROM_NAME: PMTracker System
    
    # Frontend URL
    FRONTEND_URL: http://pmtracker-frontend-2024.s3-website.ap-south-1.amazonaws.com

  iam:
    role:
      statements:
        # DynamoDB permissions
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchWriteItem
            - dynamodb:BatchGetItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/PMTracker-*
            - arn:aws:dynamodb:${self:provider.region}:*:table/PMTracker-*/index/*
        
        # S3 permissions (UPDATED with correct bucket name)
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:PutBucketCORS
            - s3:GetBucketCORS
            - s3:PutObjectAcl
            - s3:GetObjectAcl
          Resource:
            - arn:aws:s3:::pmtracker-files-mumbai-2024
            - arn:aws:s3:::pmtracker-files-mumbai-2024/*
        
        # Cognito permissions
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminDeleteUser
            - cognito-idp:ListUsers
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminResetUserPassword
          Resource: arn:aws:cognito-idp:${self:provider.region}:*:userpool/*
        
        # SES permissions
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
            - ses:VerifyEmailIdentity
          Resource: '*'
        
        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: arn:aws:logs:${self:provider.region}:*:log-group:/aws/lambda/*

functions:
  api:
    handler: src/index.handler
    events:
      # Root path with CORS
      - http:
          path: /
          method: ANY
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - Accept
              - Cache-Control
              - X-Requested-With
            allowCredentials: false
      
      # All proxy paths with CORS
      - http:
          path: /{proxy+}
          method: ANY
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - Accept
              - Cache-Control
              - X-Requested-With
            allowCredentials: false

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3001
    host: 0.0.0.0

package:
  patterns:
    - '!node_modules/**'
    - '!.git/**'
    - '!.env*'
    - '!README.md'
    - '!.gitignore'
    - 'node_modules/aws-sdk/**'
    - 'node_modules/uuid/**'
    - 'node_modules/jsonwebtoken/**'
    - 'node_modules/bcryptjs/**'
